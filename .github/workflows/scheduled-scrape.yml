name: Scheduled Scrape

on:
  schedule:
    # Run every 6 hours at minute 0
    - cron: '0 */6 * * *'
  workflow_dispatch:
    # Allow manual triggering from GitHub UI
    inputs:
      reason:
        description: 'Reason for manual trigger'
        required: false
        default: 'Manual content refresh'

env:
  # Default Railway URL - can be overridden with repository secret
  API_URL: ${{ secrets.RAILWAY_API_URL || 'https://web-production-bcd96.up.railway.app' }}

jobs:
  scrape:
    name: Trigger Content Scrape
    runs-on: ubuntu-latest

    steps:
      - name: Display trigger info
        run: |
          echo "Scrape triggered at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Trigger: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Reason: ${{ github.event.inputs.reason }}"
          fi

      - name: Check API health
        id: health
        run: |
          echo "Checking API health..."
          HEALTH_RESPONSE=$(curl -s -w "\n%{http_code}" "${{ env.API_URL }}/api/health")
          HTTP_CODE=$(echo "$HEALTH_RESPONSE" | tail -n1)
          BODY=$(echo "$HEALTH_RESPONSE" | sed '$d')

          echo "Health response: $BODY"
          echo "HTTP status: $HTTP_CODE"

          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::API health check failed with status $HTTP_CODE"
            exit 1
          fi

          echo "API is healthy"

      - name: Trigger scrape job
        id: trigger
        run: |
          echo "Triggering scrape job..."
          RESPONSE=$(curl -s -X POST "${{ env.API_URL }}/api/scrape" \
            -H "Content-Type: application/json")

          echo "Response: $RESPONSE"

          # Extract job_id using grep/sed (no jq dependency)
          JOB_ID=$(echo "$RESPONSE" | grep -o '"job_id":"[^"]*"' | sed 's/"job_id":"//;s/"//')

          if [ -z "$JOB_ID" ]; then
            echo "::error::Failed to get job ID from response"
            exit 1
          fi

          echo "Job ID: $JOB_ID"
          echo "job_id=$JOB_ID" >> $GITHUB_OUTPUT

      - name: Wait for job completion
        id: wait
        run: |
          JOB_ID="${{ steps.trigger.outputs.job_id }}"
          MAX_ATTEMPTS=30
          ATTEMPT=0

          echo "Waiting for job $JOB_ID to complete..."

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Check attempt $ATTEMPT/$MAX_ATTEMPTS..."

            RESPONSE=$(curl -s "${{ env.API_URL }}/api/jobs/$JOB_ID")
            STATUS=$(echo "$RESPONSE" | grep -o '"status":"[^"]*"' | sed 's/"status":"//;s/"//')

            echo "Status: $STATUS"

            if [ "$STATUS" = "completed" ]; then
              RESULT_COUNT=$(echo "$RESPONSE" | grep -o '"result_count":[0-9]*' | sed 's/"result_count"://')
              echo "Job completed successfully!"
              echo "Articles stored: $RESULT_COUNT"
              echo "result_count=$RESULT_COUNT" >> $GITHUB_OUTPUT
              echo "status=success" >> $GITHUB_OUTPUT
              exit 0
            elif [ "$STATUS" = "failed" ]; then
              ERROR=$(echo "$RESPONSE" | grep -o '"error_message":"[^"]*"' | sed 's/"error_message":"//;s/"//')
              echo "::error::Job failed: $ERROR"
              echo "status=failed" >> $GITHUB_OUTPUT
              exit 1
            fi

            # Wait 10 seconds before next check
            sleep 10
          done

          echo "::error::Job did not complete within timeout"
          echo "status=timeout" >> $GITHUB_OUTPUT
          exit 1

      - name: Report results
        if: always()
        run: |
          echo "============================================"
          echo "SCRAPE JOB SUMMARY"
          echo "============================================"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Job ID: ${{ steps.trigger.outputs.job_id }}"
          echo "Status: ${{ steps.wait.outputs.status || 'unknown' }}"
          echo "Articles stored: ${{ steps.wait.outputs.result_count || 'N/A' }}"
          echo "============================================"
